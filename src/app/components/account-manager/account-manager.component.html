<div class="account-manager">
  <div class="header">
    <h2>{{ t('title') }}</h2>
    <div class="actions">
      <button routerLink="/create-account" class="btn-primary btn-with-icon btn-new" [attr.aria-label]="t('createAccount')">
        <span class="btn-icon">+</span>
        <span>{{ t('createAccount') }}</span>
      </button>
      <button (click)="exportData()" class="btn-ghost btn-pill btn-export" [attr.aria-label]="t('exportCsvAria')">
        <span class="btn-icon">‚á©</span>
        <span>{{ t('exportCsv') }}</span>
      </button>
      <label class="btn-ghost btn-pill import-btn" [attr.aria-label]="t('importCsvAria')">
        <span class="btn-icon">‚á™</span>
        <span>{{ t('importCsv') }}</span>
        <input type="file" accept=".csv" (change)="importData($event)" hidden>
      </label>
    </div>
  </div>

  <button class="btn-language-floating" (click)="toggleLanguage()" [attr.aria-label]="getLanguageToggleAriaLabel()">
    <span class="btn-icon">üåê</span>
    <span>{{ getLanguageToggleLabel() }}</span>
  </button>

  <p class="local-warning">{{ t('localWarning') }}</p>

  <div class="column-selector" *ngIf="accounts.length > 0">
    <button class="btn-secondary btn-with-icon btn-columns" (click)="openColumnSelector()" [attr.aria-label]="t('columnSelectorButton')">
      <span class="btn-icon">‚ò∞</span>
      <span class="sr-only">{{ t('columnSelectorButton') }}</span>
    </button>
    <span class="column-summary">{{ getColumnSummaryText() }}</span>
  </div>

  <div class="accounts-list">
    <table class="accounts-table" *ngIf="accounts.length>0">
      <thead>
        <tr>
          <th (click)="sortBy('stt')">{{ t('stt') }} <span class="sort-indicator" *ngIf="sortColumn==='stt'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th class="col-name" (click)="sortBy('name')">{{ t('name') }} <span class="sort-indicator" *ngIf="sortColumn==='name'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <ng-container *ngFor="let option of columnOptions; trackBy: trackColumnOption">
            <th *ngIf="option.visible && !option.id.startsWith('show')"
                (click)="sortBy(option.id)"
                [class.col-numeric]="option.id !== 'logoutCountdown' && option.id !== 'riskDate'"
                [style.width]="option.width">
              {{ getColumnLabel(option) }}
              <span class="sort-indicator" *ngIf="sortColumn===option.id">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span>
            </th>
          </ng-container>
          <th *ngIf="isAnyActionVisible()" class="col-actions">{{ t('actions') }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let account of getDisplayedAccounts(); let i = index"
            [class.selected]="account.id === selectedAccount?.id"
            [class.no-volume]="hasNoVolume(account)"
            (click)="selectAccount(account.id)">
          <td class="col-stt">{{ i + 1 }}</td>
          <td class="col-name">{{ account.name }}</td>
          <ng-container *ngFor="let option of columnOptions; trackBy: trackColumnOption">
            <td *ngIf="option.visible && !option.id.startsWith('show')"
                [class.col-numeric]="option.id !== 'logoutCountdown' && option.id !== 'riskDate'"
                [style.width]="option.width"
                [ngSwitch]="option.id">
              <ng-container *ngSwitchCase="'todayStartBalance'">
                {{ getTodayStartBalance(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayPnL'">
                <span [ngClass]="{ 'positive': getTodayPnL(account) > 0, 'negative': getTodayPnL(account) < 0 }">
                  {{ getTodayPnL(account) | number:'1.1-1' }}
                </span>
              </ng-container>
              <ng-container *ngSwitchCase="'todayBalancePoints'">
                {{ getTodayBalancePoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayEndBalance'">
                {{ getTodayEndBalance(account) | number:'1.0-1' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayVolumePoints'">
                {{ getTodayVolumePoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayVolume'">
                {{ getTodayTradeVolume(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayTotalPoints'">
                {{ getTodayPoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'tomorrowPoints'">
                {{ getTomorrowPoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'riskDate'">
                {{ formatRiskDisplay(account) }}
              </ng-container>
              <ng-container *ngSwitchCase="'logoutCountdown'">
                <span *ngIf="account.lastLogin">{{ getLogoutCountdown(account) }}</span>
              </ng-container>
              <ng-container *ngSwitchCase="'totalPnL'">
                <span [ngClass]="{ 'positive': getTotalPnL(account) >= 0, 'negative': getTotalPnL(account) < 0 }">
                  {{ (getTotalPnL(account) >= 0 ? '+' : '') + (getTotalPnL(account) | number:'1.1-1') }}
                </span>
              </ng-container>
            </td>
          </ng-container>
          <td *ngIf="isAnyActionVisible()" class="col-actions">
            <div class="action-buttons">
              <button *ngIf="getColumnVisibility('showRenameButton')" class="btn-secondary btn-with-icon btn-rename" (click)="openRenameModal(account); $event.stopPropagation()" [attr.aria-label]="t('rename')">
                <span class="btn-icon">‚úé</span>
                <span class="sr-only">{{ t('rename') }}</span>
              </button>
              <button *ngIf="getColumnVisibility('showRiskButton')" class="btn-secondary btn-with-icon btn-risk" (click)="openRiskModal(account); $event.stopPropagation()" [attr.aria-label]="t('risk')">
                <span class="btn-icon">‚ö†</span>
                <span class="sr-only">{{ t('risk') }}</span>
              </button>
              <button *ngIf="getColumnVisibility('showLoginButton')" class="btn-secondary btn-with-icon btn-login" (click)="openLoginModal(account); $event.stopPropagation()" [attr.aria-label]="t('login')">
                <span class="btn-icon">üïí</span>
                <span class="sr-only">{{ t('login') }}</span>
              </button>
              <button *ngIf="getColumnVisibility('showDeleteButton')" class="btn-danger btn-with-icon btn-delete-one" (click)="deleteAccount(account.id); $event.stopPropagation()" [attr.aria-label]="t('delete')">
                <span class="btn-icon">üóë</span>
                <span class="sr-only">{{ t('delete') }}</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="accounts.length === 0" class="no-accounts">
      {{ t('noAccounts') }}
    </div>
  </div>
</div>

<!-- ƒê·∫∑t modal popup ghi nh·∫≠n login ngay sau th·∫ª ƒë√≥ng div.account-manager ƒë·ªÉ ƒë·∫£m b·∫£o overlay to√†n trang v√† kh√¥ng b·ªã che -->
<div *ngIf="showLoginModal" class="login-modal">
  <div class="login-modal-content">
    <button class="btn-close" (click)="closeLoginModal()">√ó</button>
    <h3>{{ t('loginModalTitle') }}: {{ loginAccount?.name }}</h3>
  <label>{{ t('loginModalLabel') }}</label>
    <input type="datetime-local" [(ngModel)]="loginTime" />
    <div class="modal-actions">
      <button class="btn-primary left" (click)="confirmLoginWithTime()">{{ t('confirm') }}</button>
    </div>
  </div>
</div>

<div *ngIf="showColumnSelector" class="modal-overlay">
  <div class="modal-content columns">
    <h3>{{ t('columnModalTitle') }}</h3>
    <div class="column-list">
      <label *ngFor="let option of columnOptions; trackBy: trackColumnOption">
   <input type="checkbox"
     [checked]="tempColumnVisibility[option.id]"
     (change)="toggleTempColumn(option.id, $any($event.target).checked)" />
        {{ getColumnLabel(option) }}
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmColumnSelection()">{{ t('confirm') }}</button>
      <button class="btn-secondary" (click)="cancelColumnSelection()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<div *ngIf="showRenameModal" class="modal-overlay">
  <div class="modal-content rename">
    <h3>{{ t('renameModalTitle') }}</h3>
    <p *ngIf="renameAccount" class="rename-subtitle">{{ t('renameModalSubtitle') }} <strong>{{ renameAccount.name }}</strong></p>
    <label for="rename-input">{{ t('renameModalInput') }}</label>
    <input id="rename-input" type="text" [(ngModel)]="renameName" [placeholder]="t('renameModalInput')" />
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmRename()">{{ t('save') }}</button>
      <button class="btn-secondary" (click)="closeRenameModal()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<div *ngIf="showRiskModal" class="modal-overlay">
  <div class="modal-content risk">
    <h3>{{ t('riskModalTitle') }}</h3>
    <p *ngIf="riskAccount" class="risk-subtitle">{{ t('riskModalAccount') }} <strong>{{ riskAccount.name }}</strong></p>
    <label for="risk-date">{{ t('riskModalDateLabel') }}</label>
    <input id="risk-date" type="date" [(ngModel)]="riskDateInput" />
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmRiskDate()">{{ t('save') }}</button>
      <button class="btn-danger" *ngIf="riskAccount?.riskDate" (click)="clearRiskDate()">{{ t('remove') }}</button>
      <button class="btn-secondary" (click)="closeRiskModal()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<div class="debug-status" style="position:fixed;bottom:10px;right:10px;z-index:99999;">
  showLoginModal: {{ showLoginModal }}<br>
  loginAccount: {{ loginAccount?.name || '-' }}<br>
  loginTime: {{ loginTime || '-' }}
</div>
