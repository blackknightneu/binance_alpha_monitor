<div class="account-manager">
  <div class="header">
    <h2>Qu·∫£n l√Ω t√†i kho·∫£n</h2>
    <div class="actions">
      <button routerLink="/create-account" class="btn-primary btn-with-icon btn-new" aria-label="T·∫°o t√†i kho·∫£n m·ªõi">
        <span class="btn-icon">+</span>
        <span class="sr-only">T·∫°o t√†i kho·∫£n m·ªõi</span>
      </button>
       <button (click)="deleteAllAccounts()" class="btn-danger btn-with-icon btn-delete-all" aria-label="X√≥a t·∫•t c·∫£ t√†i kho·∫£n">
        <span class="btn-icon">üóë</span>
        <span class="sr-only">X√≥a t·∫•t c·∫£ t√†i kho·∫£n</span>
      </button>
      <button (click)="exportData()" class="btn-ghost btn-with-icon btn-export" aria-label="Xu·∫•t d·ªØ li·ªáu">
        <span class="btn-icon">‚á©</span>
        <span class="sr-only">Xu·∫•t d·ªØ li·ªáu</span>
      </button>
      <label class="btn-ghost import-btn btn-with-icon" aria-label="Nh·∫≠p d·ªØ li·ªáu">
        <span class="btn-icon">‚á™</span>
        <span class="sr-only">Nh·∫≠p d·ªØ li·ªáu</span>
        <input type="file" accept=".csv" (change)="importData($event)" hidden>
      </label>
    </div>
  </div>

  <p class="local-warning">D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c l∆∞u t·∫°m tr√™n m√°y c·ªßa b·∫°n, vui l√≤ng sao l∆∞u th∆∞·ªùng xuy√™n.</p>

  <div class="column-selector" *ngIf="accounts.length > 0">
    <button class="btn-secondary btn-with-icon btn-columns" (click)="openColumnSelector()" aria-label="Ch·ªçn c·ªôt hi·ªÉn th·ªã">
      <span class="btn-icon">‚ò∞</span>
      <span class="sr-only">Ch·ªçn c·ªôt hi·ªÉn th·ªã</span>
    </button>
    <span class="column-summary">ƒêang hi·ªÉn th·ªã {{ getVisibleColumnCount() }} / {{ columnOptions.length }} c·ªôt</span>
  </div>

  <div class="accounts-list">
    <table class="accounts-table" *ngIf="accounts.length>0">
      <thead>
        <tr>
          <th (click)="sortBy('stt')">STT <span class="sort-indicator" *ngIf="sortColumn==='stt'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th (click)="sortBy('name')">T√™n <span class="sort-indicator" *ngIf="sortColumn==='name'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <ng-container *ngFor="let option of columnOptions; trackBy: trackColumnOption">
            <th *ngIf="option.visible"
                (click)="sortBy(option.id)"
                [class.col-numeric]="option.id !== 'logoutCountdown' && option.id !== 'riskDate'">
              {{ option.label }}
              <span class="sort-indicator" *ngIf="sortColumn===option.id">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span>
            </th>
          </ng-container>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let account of getDisplayedAccounts(); let i = index"
            [class.selected]="account.id === selectedAccount?.id"
            [class.no-volume]="hasNoVolume(account)"
            (click)="selectAccount(account.id)">
          <td class="col-stt">{{ i + 1 }}</td>
          <td class="col-name">{{ account.name }}</td>
          <ng-container *ngFor="let option of columnOptions; trackBy: trackColumnOption">
            <td *ngIf="option.visible"
                [class.col-numeric]="option.id !== 'logoutCountdown' && option.id !== 'riskDate'"
                [ngSwitch]="option.id">
              <ng-container *ngSwitchCase="'todayStartBalance'">
                {{ getTodayStartBalance(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayCost'">
                <span [ngClass]="{ 'positive': getTodayCost(account) < 0, 'negative': getTodayCost(account) > 0 }">
                  {{ getTodayCost(account) | number:'1.1-1' }}
                </span>
              </ng-container>
              <ng-container *ngSwitchCase="'todayBalancePoints'">
                {{ getTodayBalancePoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayEndBalance'">
                {{ getTodayEndBalance(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayVolumePoints'">
                {{ getTodayVolumePoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayVolume'">
                {{ getTodayTradeVolume(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayTotalPoints'">
                {{ getTodayPoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'tomorrowPoints'">
                {{ getTomorrowPoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'riskDate'">
                {{ formatRiskDisplay(account) }}
              </ng-container>
              <ng-container *ngSwitchCase="'logoutCountdown'">
                <span *ngIf="account.lastLogin">{{ getLogoutCountdown(account) }}</span>
              </ng-container>
              <ng-container *ngSwitchCase="'totalPnL'">
                <span [ngClass]="{ 'positive': getTotalPnL(account) >= 0, 'negative': getTotalPnL(account) < 0 }">
                  {{ (getTotalPnL(account) >= 0 ? '+' : '') + (getTotalPnL(account) | number:'1.1-1') }}
                </span>
              </ng-container>
            </td>
          </ng-container>
          <td class="col-actions">
            <div class="action-buttons">
              <button class="btn-secondary btn-with-icon btn-rename" (click)="openRenameModal(account); $event.stopPropagation()" aria-label="ƒê·ªïi t√™n t√†i kho·∫£n">
                <span class="btn-icon">‚úé</span>
                <span class="sr-only">ƒê·ªïi t√™n t√†i kho·∫£n</span>
              </button>
              <button class="btn-secondary btn-with-icon btn-risk" (click)="openRiskModal(account); $event.stopPropagation()" aria-label="Ghi nh·∫≠n ng√†y b·ªã risk">
                <span class="btn-icon">‚ö†</span>
                <span class="sr-only">Ghi nh·∫≠n ng√†y b·ªã risk</span>
              </button>
              <button class="btn-secondary btn-with-icon btn-login" (click)="openLoginModal(account); $event.stopPropagation()" aria-label="Ghi nh·∫≠n ƒëƒÉng nh·∫≠p">
                <span class="btn-icon">üïí</span>
                <span class="sr-only">Ghi nh·∫≠n ƒëƒÉng nh·∫≠p</span>
              </button>
              <button class="btn-danger btn-with-icon btn-delete-one" (click)="deleteAccount(account.id); $event.stopPropagation()" aria-label="X√≥a t√†i kho·∫£n">
                <span class="btn-icon">üóë</span>
                <span class="sr-only">X√≥a t√†i kho·∫£n</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="accounts.length === 0" class="no-accounts">
      Ch∆∞a c√≥ t√†i kho·∫£n n√†o. Nh·∫•n "T·∫°o t√†i kho·∫£n" ƒë·ªÉ th√™m m·ªõi.
    </div>
  </div>
</div>

<!-- ƒê·∫∑t modal popup ghi nh·∫≠n login ngay sau th·∫ª ƒë√≥ng div.account-manager ƒë·ªÉ ƒë·∫£m b·∫£o overlay to√†n trang v√† kh√¥ng b·ªã che -->
<div *ngIf="showLoginModal" class="login-modal">
  <div class="login-modal-content">
    <button class="btn-close" (click)="closeLoginModal()">√ó</button>
    <h3>Ghi nh·∫≠n ƒëƒÉng nh·∫≠p cho t√†i kho·∫£n: {{ loginAccount?.name }}</h3>
  <label>Th·ªùi gian ƒëƒÉng nh·∫≠p (GMT+7):</label>
    <input type="datetime-local" [(ngModel)]="loginTime" />
    <div class="modal-actions">
      <button class="btn-primary left" (click)="confirmLoginWithTime()">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>

<div *ngIf="showColumnSelector" class="modal-overlay">
  <div class="modal-content columns">
    <h3>Ch·ªçn c·ªôt hi·ªÉn th·ªã</h3>
    <div class="column-list">
      <label *ngFor="let option of columnOptions; trackBy: trackColumnOption">
   <input type="checkbox"
     [checked]="tempColumnVisibility[option.id]"
     (change)="toggleTempColumn(option.id, $any($event.target).checked)" />
        {{ option.label }}
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmColumnSelection()">X√°c nh·∫≠n</button>
      <button class="btn-secondary" (click)="cancelColumnSelection()">H·ªßy</button>
    </div>
  </div>
</div>

<div *ngIf="showRenameModal" class="modal-overlay">
  <div class="modal-content rename">
    <h3>ƒê·ªïi t√™n t√†i kho·∫£n</h3>
    <p *ngIf="renameAccount" class="rename-subtitle">T√†i kho·∫£n hi·ªán t·∫°i: <strong>{{ renameAccount.name }}</strong></p>
    <label for="rename-input">T√™n m·ªõi</label>
    <input id="rename-input" type="text" [(ngModel)]="renameName" placeholder="Nh·∫≠p t√™n m·ªõi" />
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmRename()">L∆∞u</button>
      <button class="btn-secondary" (click)="closeRenameModal()">H·ªßy</button>
    </div>
  </div>
</div>

<div *ngIf="showRiskModal" class="modal-overlay">
  <div class="modal-content risk">
    <h3>Ghi nh·∫≠n ng√†y b·ªã risk</h3>
    <p *ngIf="riskAccount" class="risk-subtitle">T√†i kho·∫£n: <strong>{{ riskAccount.name }}</strong></p>
    <label for="risk-date">Ng√†y b·ªã risk</label>
    <input id="risk-date" type="date" [(ngModel)]="riskDateInput" />
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmRiskDate()">L∆∞u</button>
      <button class="btn-danger" *ngIf="riskAccount?.riskDate" (click)="clearRiskDate()">X√≥a</button>
      <button class="btn-secondary" (click)="closeRiskModal()">H·ªßy</button>
    </div>
  </div>
</div>

<div class="debug-status" style="position:fixed;bottom:10px;right:10px;z-index:99999;">
  showLoginModal: {{ showLoginModal }}<br>
  loginAccount: {{ loginAccount?.name || '-' }}<br>
  loginTime: {{ loginTime || '-' }}
</div>
