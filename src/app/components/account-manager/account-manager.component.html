<div class="account-manager">
  <div class="header">
    <h2>Qu·∫£n l√Ω t√†i kho·∫£n</h2>
    <div class="actions">
      <button routerLink="/create-account" class="btn-primary btn-with-icon btn-new" aria-label="T·∫°o t√†i kho·∫£n m·ªõi">
        <span class="btn-icon">+</span>
        <span class="sr-only">T·∫°o t√†i kho·∫£n m·ªõi</span>
      </button>
       <button (click)="deleteAllAccounts()" class="btn-danger btn-with-icon btn-delete-all" aria-label="X√≥a t·∫•t c·∫£ t√†i kho·∫£n">
        <span class="btn-icon">üóë</span>
        <span class="sr-only">X√≥a t·∫•t c·∫£ t√†i kho·∫£n</span>
      </button>
      <button (click)="exportData()" class="btn-ghost btn-with-icon btn-export" aria-label="Xu·∫•t d·ªØ li·ªáu">
        <span class="btn-icon">‚á©</span>
        <span class="sr-only">Xu·∫•t d·ªØ li·ªáu</span>
      </button>
      <label class="btn-ghost import-btn btn-with-icon" aria-label="Nh·∫≠p d·ªØ li·ªáu">
        <span class="btn-icon">‚á™</span>
        <span class="sr-only">Nh·∫≠p d·ªØ li·ªáu</span>
        <input type="file" accept=".csv" (change)="importData($event)" hidden>
      </label>
    </div>
  </div>

  <p class="local-warning">D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c l∆∞u t·∫°m tr√™n m√°y c·ªßa b·∫°n, vui l√≤ng sao l∆∞u th∆∞·ªùng xuy√™n.</p>

  <div class="accounts-list">
    <table class="accounts-table" *ngIf="accounts.length>0">
      <thead>
        <tr>
          <th (click)="sortBy('stt')">STT <span class="sort-indicator" *ngIf="sortColumn==='stt'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th (click)="sortBy('name')">T√™n <span class="sort-indicator" *ngIf="sortColumn==='name'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th class="col-numeric" (click)="sortBy('balance')">S·ªë d∆∞ <span class="sort-indicator" *ngIf="sortColumn==='balance'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th class="col-numeric" (click)="sortBy('todayPoints')">ƒêi·ªÉm h√¥m nay <span class="sort-indicator" *ngIf="sortColumn==='todayPoints'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th class="col-numeric" (click)="sortBy('tomorrowPoints')">ƒêi·ªÉm ng√†y mai <span class="sort-indicator" *ngIf="sortColumn==='tomorrowPoints'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th class="col-numeric" (click)="sortBy('pnl')">PnL (h√¥m nay) <span class="sort-indicator" *ngIf="sortColumn==='pnl'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th class="col-numeric" (click)="sortBy('tradeVolume')">Kh·ªëi l∆∞·ª£ng h√¥m nay <span class="sort-indicator" *ngIf="sortColumn==='tradeVolume'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th class="col-numeric" (click)="sortBy('logoutCountdown')">ƒêƒÉng xu·∫•t <span class="sort-indicator" *ngIf="sortColumn==='logoutCountdown'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody>
    <tr *ngFor="let account of getDisplayedAccounts(); let i = index"
      [class.selected]="account.id === selectedAccount?.id"
      [class.no-volume]="hasNoVolume(account)"
      (click)="selectAccount(account.id)">
          <td class="col-stt">{{ i + 1 }}</td>
          <td class="col-name">{{ account.name }}</td>
          <td class="col-numeric"> {{ account.balance | number:'1.1-1' }}</td>
          <!-- 15d Points cell removed -->
          <td class="col-numeric">{{ getTodayPoints(account) }}</td>
          <td class="col-numeric">{{ getTomorrowPoints(account) }}</td>
          <td class="col-numeric" [ngClass]="{ 'positive': getPnL(account)>0, 'negative': getPnL(account)<0 }">{{ (getPnL(account) >= 0 ? '+' : '') + (getPnL(account) | number:'1.1-1') }}</td>
          <td class="col-numeric">
            {{ getTodayTradeVolume(account) === undefined ? '' : getTodayTradeVolume(account) }}
          </td>
          <td class="col-numeric">
            <span *ngIf="account.lastLogin">{{ getLogoutCountdown(account) }}</span>
          </td>
          <td class="col-actions">
            <div class="action-buttons">
              <button class="btn-secondary btn-with-icon btn-login" (click)="openLoginModal(account); $event.stopPropagation()" aria-label="Ghi nh·∫≠n ƒëƒÉng nh·∫≠p">
                <span class="btn-icon">üïí</span>
                <span class="sr-only">Ghi nh·∫≠n ƒëƒÉng nh·∫≠p</span>
              </button>
              <button class="btn-danger btn-with-icon btn-delete-one" (click)="deleteAccount(account.id); $event.stopPropagation()" aria-label="X√≥a t√†i kho·∫£n">
                <span class="btn-icon">üóë</span>
                <span class="sr-only">X√≥a t√†i kho·∫£n</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="accounts.length === 0" class="no-accounts">
      Ch∆∞a c√≥ t√†i kho·∫£n n√†o. Nh·∫•n "T·∫°o t√†i kho·∫£n" ƒë·ªÉ th√™m m·ªõi.
    </div>
  </div>
</div>

<!-- ƒê·∫∑t modal popup ghi nh·∫≠n login ngay sau th·∫ª ƒë√≥ng div.account-manager ƒë·ªÉ ƒë·∫£m b·∫£o overlay to√†n trang v√† kh√¥ng b·ªã che -->
<div *ngIf="showLoginModal" class="login-modal">
  <div class="login-modal-content">
    <button class="btn-close" (click)="closeLoginModal()">√ó</button>
    <h3>Ghi nh·∫≠n ƒëƒÉng nh·∫≠p cho t√†i kho·∫£n: {{ loginAccount?.name }}</h3>
  <label>Th·ªùi gian ƒëƒÉng nh·∫≠p (GMT+7):</label>
    <input type="datetime-local" [(ngModel)]="loginTime" />
    <div class="modal-actions">
      <button class="btn-primary left" (click)="confirmLoginWithTime()">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>

<div class="debug-status" style="position:fixed;bottom:10px;right:10px;z-index:99999;">
  showLoginModal: {{ showLoginModal }}<br>
  loginAccount: {{ loginAccount?.name || '-' }}<br>
  loginTime: {{ loginTime || '-' }}
</div>
