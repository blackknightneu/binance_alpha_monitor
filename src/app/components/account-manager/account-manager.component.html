<div class="account-manager">
  <div class="header">
    <h2>{{ t('title') }}</h2>

    <div class="actions">
      <button routerLink="/create-account" class="btn-primary btn-with-icon btn-new" [attr.aria-label]="t('createAccount')">
        <span class="btn-icon">+</span>
        <span>{{ t('createAccount') }}</span>
      </button>
      <button (click)="exportData()" class="btn-ghost btn-pill btn-export" [attr.aria-label]="t('exportCsvAria')">
        <span class="btn-icon">‚á©</span>
        <span>{{ t('exportCsv') }}</span>
      </button>
      <label class="btn-ghost btn-pill import-btn" [attr.aria-label]="t('importCsvAria')">
        <span class="btn-icon">‚á™</span>
        <span>{{ t('importCsv') }}</span>
        <input type="file" accept=".csv" (change)="importData($event)" hidden>
      </label>
      <button (click)="openCustomFieldsModal()" class="btn-secondary btn-pill" [attr.aria-label]="t('customManageFields')">
        <span class="btn-icon">‚öôÔ∏è</span>
        <span>{{ t('customManageFields') }}</span>
      </button>
    </div>
  </div>

  <button class="btn-language-floating" (click)="toggleLanguage()" [attr.aria-label]="getLanguageToggleAriaLabel()">
    <span class="btn-icon">üåê</span>
    <span>{{ getLanguageToggleLabel() }}</span>
  </button>

  <p class="local-warning">{{ t('localWarning') }}</p>

  <div class="column-selector" *ngIf="accounts.length > 0">
    <button class="btn-secondary btn-with-icon btn-columns" (click)="openColumnSelector()" [attr.aria-label]="t('columnSelectorButton')">
      <span class="btn-icon">‚ò∞</span>
      <span class="sr-only">{{ t('columnSelectorButton') }}</span>
    </button>
    <span class="column-summary">{{ getColumnSummaryText() }}</span>
  </div>

  <div class="accounts-list">
    <table class="accounts-table" *ngIf="accounts.length>0">
      <thead>
        <tr>
          <th (click)="sortBy('stt')">{{ t('stt') }} <span class="sort-indicator" *ngIf="sortColumn==='stt'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <th class="col-name" (click)="sortBy('name')">{{ t('name') }} <span class="sort-indicator" *ngIf="sortColumn==='name'">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span></th>
          <ng-container *ngFor="let option of columnOptions; trackBy: trackColumnOption">
            <th *ngIf="option.visible && !option.id.startsWith('show')"
                (click)="sortBy(option.id)"
                [class.col-numeric]="option.id !== 'logoutCountdown' && option.id !== 'riskDate'"
                [style.width]="option.width">
              {{ getColumnLabel(option) }}
              <span class="sort-indicator" *ngIf="sortColumn===option.id">{{ sortDir==='asc'?'‚ñ≤':'‚ñº' }}</span>
            </th>
          </ng-container>
          <th *ngIf="isAnyActionVisible()" class="col-actions">{{ t('actions') }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let account of getDisplayedAccounts(); let i = index"
            [class.selected]="account.id === selectedAccount?.id"
            [class.no-volume]="hasNoVolume(account)"
            (click)="selectAccount(account.id)">
          <td class="col-stt">{{ i + 1 }}</td>
          <td class="col-name">{{ account.name }}</td>
          <ng-container *ngFor="let option of columnOptions; trackBy: trackColumnOption">
            <td *ngIf="option.visible && !option.id.startsWith('show')"
                [class.col-numeric]="option.id !== 'logoutCountdown' && option.id !== 'riskDate'"
                [style.width]="option.width"
                [ngSwitch]="option.id">
              <ng-container *ngSwitchCase="'todayStartBalance'">
                {{ getTodayStartBalance(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayPnL'">
                <span [ngClass]="{ 'positive': getTodayPnL(account) > 0, 'negative': getTodayPnL(account) < 0 }">
                  {{ getTodayPnL(account) | number:'1.1-1' }}
                </span>
              </ng-container>
              <ng-container *ngSwitchCase="'todayProfit'">
                <span [ngClass]="{ 'positive': getTodayProfit(account) > 0, 'negative': getTodayProfit(account) < 0 }">
                  {{ getTodayProfit(account) | number:'1.1-1' }}
                </span>
              </ng-container>
              <ng-container *ngSwitchCase="'todayBalancePoints'">
                {{ getTodayBalancePoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayEndBalance'">
                {{ getTodayEndBalance(account) | number:'1.0-1' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayVolumePoints'">
                {{ getTodayVolumePoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayVolume'">
                {{ getTodayTradeVolume(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'todayTotalPoints'">
                {{ getTodayPoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'tomorrowPoints'">
                {{ getTomorrowPoints(account) | number:'1.0-0' }}
              </ng-container>
              <ng-container *ngSwitchCase="'riskDate'">
                {{ formatRiskDisplay(account) }}
              </ng-container>
              <ng-container *ngSwitchCase="'logoutCountdown'">
                <span *ngIf="account.lastLogin">{{ getLogoutCountdown(account) }}</span>
              </ng-container>
              <ng-container *ngSwitchCase="'totalPnL'">
                <span [ngClass]="{ 'positive': getTotalPnL(account) >= 0, 'negative': getTotalPnL(account) < 0 }">
                  {{ (getTotalPnL(account) >= 0 ? '+' : '') + (getTotalPnL(account) | number:'1.1-1') }}
                </span>
              </ng-container>
              <!-- Custom Fields -->
              <ng-container *ngIf="option.id.startsWith('custom_')">
                <ng-container *ngIf="getFieldDefinition(option.id)">
                  <ng-container *ngIf="getFieldDefinition(option.id)?.type === 'boolean'">
                    <span *ngIf="getCustomFieldValue(account, getFieldDefinition(option.id)?.id || '')">‚úì</span>
                    <span *ngIf="!getCustomFieldValue(account, getFieldDefinition(option.id)?.id || '')">‚úó</span>
                  </ng-container>
                  <ng-container *ngIf="getFieldDefinition(option.id)?.type === 'text'">
                    {{ getCustomFieldValue(account, getFieldDefinition(option.id)?.id || '') }}
                  </ng-container>
                </ng-container>
              </ng-container>
            </td>
          </ng-container>
          <td *ngIf="isAnyActionVisible()" class="col-actions">
            <div class="action-buttons">
              <button *ngIf="getColumnVisibility('showRenameButton')" class="btn-secondary btn-with-icon btn-rename" (click)="openRenameModal(account); $event.stopPropagation()" [attr.aria-label]="t('rename')">
                <span class="btn-icon">‚úé</span>
                <span class="sr-only">{{ t('rename') }}</span>
              </button>
              <button *ngIf="getColumnVisibility('showRiskButton')" class="btn-secondary btn-with-icon btn-risk" (click)="openRiskModal(account); $event.stopPropagation()" [attr.aria-label]="t('risk')">
                <span class="btn-icon">‚ö†</span>
                <span class="sr-only">{{ t('risk') }}</span>
              </button>
              <button *ngIf="getColumnVisibility('showLoginButton')" class="btn-secondary btn-with-icon btn-login" (click)="openLoginModal(account); $event.stopPropagation()" [attr.aria-label]="t('login')">
                <span class="btn-icon">üïí</span>
                <span class="sr-only">{{ t('login') }}</span>
              </button>
              <button *ngIf="getColumnVisibility('showDeleteButton')" class="btn-danger btn-with-icon btn-delete-one" (click)="deleteAccount(account.id); $event.stopPropagation()" [attr.aria-label]="t('delete')">
                <span class="btn-icon">üóë</span>
                <span class="sr-only">{{ t('delete') }}</span>
              </button>
              <button *ngIf="customFields.length > 0" class="btn-secondary btn-with-icon" (click)="openEditCustomFieldsModal(account); $event.stopPropagation()" [attr.aria-label]="t('customEditInfo')">
                <span class="btn-icon">üìù</span>
                <span class="sr-only">{{ t('customEditInfo') }}</span>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="accounts.length === 0" class="no-accounts">
      {{ t('noAccounts') }}
    </div>
  </div>
</div>

<!-- ƒê·∫∑t modal popup ghi nh·∫≠n login ngay sau th·∫ª ƒë√≥ng div.account-manager ƒë·ªÉ ƒë·∫£m b·∫£o overlay to√†n trang v√† kh√¥ng b·ªã che -->
<div *ngIf="showLoginModal" class="login-modal">
  <div class="login-modal-content">
    <button class="btn-close" (click)="closeLoginModal()">√ó</button>
    <h3>{{ t('loginModalTitle') }}: {{ loginAccount?.name }}</h3>
  <label>{{ t('loginModalLabel') }}</label>
    <input type="datetime-local" [(ngModel)]="loginTime" />
    <div class="modal-actions">
      <button class="btn-primary left" (click)="confirmLoginWithTime()">{{ t('confirm') }}</button>
      <button class="btn-secondary" (click)="closeLoginModal()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<div *ngIf="showColumnSelector" class="modal-overlay">
  <div class="modal-content columns">
    <h3>{{ t('columnModalTitle') }}</h3>
    <div class="column-list">
      <label *ngFor="let option of columnOptions; trackBy: trackColumnOption">
   <input type="checkbox"
     [checked]="tempColumnVisibility[option.id]"
     (change)="toggleTempColumn(option.id, $any($event.target).checked)" />
        {{ getColumnLabel(option) }}
      </label>
    </div>
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmColumnSelection()">{{ t('confirm') }}</button>
      <button class="btn-secondary" (click)="cancelColumnSelection()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<div *ngIf="showRenameModal" class="modal-overlay">
  <div class="modal-content rename">
    <h3>{{ t('renameModalTitle') }}</h3>
    <p *ngIf="renameAccount" class="rename-subtitle">{{ t('renameModalSubtitle') }} <strong>{{ renameAccount.name }}</strong></p>
    <label for="rename-input">{{ t('renameModalInput') }}</label>
    <input id="rename-input" type="text" [(ngModel)]="renameName" [placeholder]="t('renameModalInput')" />
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmRename()">{{ t('save') }}</button>
      <button class="btn-secondary" (click)="closeRenameModal()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<div *ngIf="showRiskModal" class="modal-overlay">
  <div class="modal-content risk">
    <h3>{{ t('riskModalTitle') }}</h3>
    <p *ngIf="riskAccount" class="risk-subtitle">{{ t('riskModalAccount') }} <strong>{{ riskAccount.name }}</strong></p>
    <label for="risk-date">{{ t('riskModalDateLabel') }}</label>
    <input id="risk-date" type="date" [(ngModel)]="riskDateInput" />
    <div class="modal-actions">
      <button class="btn-primary" (click)="confirmRiskDate()">{{ t('save') }}</button>
      <button class="btn-danger" *ngIf="riskAccount?.riskDate" (click)="clearRiskDate()">{{ t('remove') }}</button>
      <button class="btn-secondary" (click)="closeRiskModal()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<!-- Custom Fields Management Modal -->
<div *ngIf="showCustomFieldsModal" class="modal-overlay" (click)="closeCustomFieldsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>{{ t('customManageFields') }}</h3>

    <div class="modal-actions" style="margin-bottom: 1rem;">
      <button class="btn-primary" (click)="openAddFieldModal()">{{ t('customAddNewField') }}</button>
      <button class="btn-secondary" (click)="closeCustomFieldsModal()">{{ t('cancel') }}</button>
    </div>

    <div *ngIf="customFields.length === 0" style="text-align: center; padding: 2rem; color: #666;">
      {{ t('customNoFieldsDefined') }}. {{ t('customAddNewField') | lowercase }} {{ t('createAccount') | lowercase }}.
    </div>

    <div *ngIf="customFields.length > 0" class="field-list" style="max-height: 300px; overflow-y: auto;">
      <div *ngFor="let field of customFields" class="field-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 0.5rem;">
        <div>
          <strong>{{ field.name }}</strong>
          <span style="color: #666; font-size: 0.9rem;">({{ field.type === 'text' ? t('customTextType') : t('customBooleanType') }})</span>
        </div>
        <button class="btn-danger btn-with-icon" (click)="deleteCustomField(field.id)" style="margin-left: 0.5rem;">
          <span class="btn-icon">üóë</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Custom Field Modal -->
<div *ngIf="showAddFieldModal" class="modal-overlay" (click)="closeAddFieldModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>{{ t('customAddNewField') }}</h3>

    <div style="margin-bottom: 1rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">{{ t('customFieldName') }}:</label>
      <input type="text" [(ngModel)]="newFieldName" [placeholder]="'V√≠ d·ª•: ' + (language === 'vi' ? 'Ghi ch√∫, VIP,...' : 'Notes, VIP,...')" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 8px;">
    </div>

    <div style="margin-bottom: 1rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">{{ t('customFieldType') }}:</label>
      <select [(ngModel)]="newFieldType" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 8px;">
        <option value="text">{{ t('customTextType') }}</option>
        <option value="boolean">{{ t('customBooleanType') }}</option>
      </select>
    </div>

    <div class="modal-actions">
      <button class="btn-primary" (click)="addCustomField()">{{ t('customAddField') }}</button>
      <button class="btn-secondary" (click)="closeAddFieldModal()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<!-- Edit Custom Fields Modal -->
<div *ngIf="showEditCustomFieldsModal" class="modal-overlay" (click)="closeEditCustomFieldsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h3>{{ t('customEditInfo') }} - {{ editAccount?.name }}</h3>

    <div *ngIf="customFields.length === 0" style="text-align: center; padding: 2rem; color: #666;">
      {{ t('customNoFieldsDefined') }}.
    </div>

    <div *ngIf="customFields.length > 0" style="max-height: 400px; overflow-y: auto;">
      <div *ngFor="let field of customFields" style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">{{ field.name }}:</label>

        <div *ngIf="field.type === 'text'">
          <input type="text" [(ngModel)]="customFieldValues[field.id]" [placeholder]="(language === 'vi' ? 'Nh·∫≠p ' : 'Enter ') + (field.name | lowercase) + '...'" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 8px;">
        </div>

        <div *ngIf="field.type === 'boolean'">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" [(ngModel)]="customFieldValues[field.id]">
            <span>{{ field.name }}</span>
          </label>
        </div>
      </div>
    </div>

    <div class="modal-actions" style="margin-top: 1rem;">
      <button class="btn-primary" (click)="saveCustomFieldValues()">{{ t('customSave') }}</button>
      <button class="btn-secondary" (click)="closeEditCustomFieldsModal()">{{ t('cancel') }}</button>
    </div>
  </div>
</div>

<div class="debug-status" style="position:fixed;bottom:10px;right:10px;z-index:99999;">
  showLoginModal: {{ showLoginModal }}<br>
  loginAccount: {{ loginAccount?.name || '-' }}<br>
  loginTime: {{ loginTime || '-' }}
</div>
